<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "f57852cac3a86c4a5ef47f793cc12178",
  "translation_date": "2025-06-11T04:48:35+00:00",
  "source_file": "06-building-trustworthy-agents/README.md",
  "language_code": "ja"
}
-->
[![Trustworthy AI Agents](../../../06-building-trustworthy-agents/images/lesson-6-thumbnail.png)](https://youtu.be/iZKkMEGBCUQ?si=Q-kEbcyHUMPoHp8L)

> _(上の画像をクリックすると、このレッスンの動画が視聴できます)_

# 信頼できるAIエージェントの構築

## はじめに

このレッスンでは以下を扱います：

- 安全かつ効果的なAIエージェントの構築と展開方法
- AIエージェント開発における重要なセキュリティ上の考慮点
- AIエージェント開発時のデータとユーザープライバシーの維持方法

## 学習目標

このレッスンを終えた後、以下ができるようになります：

- AIエージェント作成時のリスクを特定し、軽減する方法
- データとアクセスを適切に管理するためのセキュリティ対策の実装
- データプライバシーを守りつつ、質の高いユーザー体験を提供するAIエージェントの作成

## 安全性

まずは安全なエージェント型アプリケーションの構築について見ていきましょう。安全性とは、AIエージェントが設計通りに動作することを意味します。エージェント型アプリケーションの開発者として、安全性を最大化するための手法やツールがあります。

### システムメッセージフレームワークの構築

もしLarge Language Models（LLMs）を使ったAIアプリケーションを作ったことがあれば、堅牢なシステムプロンプトやシステムメッセージの設計がいかに重要かご存じでしょう。これらのプロンプトは、LLMがユーザーやデータとどのようにやり取りするかのメタルールや指示、ガイドラインを設定します。

AIエージェントの場合、システムプロンプトはさらに重要です。なぜなら、AIエージェントは私たちが設計したタスクを完遂するために、非常に具体的な指示が必要だからです。

スケーラブルなシステムプロンプトを作成するために、アプリケーション内で1つ以上のエージェントを構築するためのシステムメッセージフレームワークを使うことができます：

![Building a System Message Framework](../../../06-building-trustworthy-agents/images/system-message-framework.png)

#### ステップ1: メタシステムメッセージの作成

メタプロンプトは、LLMが私たちが作成するエージェントのシステムプロンプトを生成するために使います。複数のエージェントを効率的に作成できるよう、テンプレートとして設計します。

以下はLLMに与えるメタシステムメッセージの例です：

```plaintext
あなたはAIエージェント用アシスタントのシステムプロンプト作成に精通した専門家です。
会社名、役割、責務などの情報が与えられます。これらを用いてシステムプロンプトを作成してください。
システムプロンプトはできるだけ具体的に記述し、LLM を用いるシステムが
AI アシスタントの役割と責務を正確に理解できるよう、明確な構造を与えてください。
```

#### ステップ2: 基本プロンプトの作成

次に、AIエージェントを説明する基本プロンプトを作成します。エージェントの役割、担当するタスク、その他の責任事項を含めるべきです。

例を示します：

```plaintext
あなたは Contoso Travel の旅行代理店で、顧客の航空券予約が得意な AI アシスタントです。
顧客を支援するために次のタスクを実行できます：利用可能なフライトの検索、フライトの予約、
座席やフライト時間の希望の確認、予約済みフライトのキャンセル、フライトの遅延や欠航の通知。
```

#### ステップ3: 基本システムメッセージをLLMに提供

ここで、メタシステムメッセージをシステムメッセージとして、基本システムメッセージとともに提供し、システムメッセージを最適化します。

これにより、AIエージェントを効果的に導くためのより良いシステムメッセージが生成されます：

```markdown
**会社名:** Contoso Travel  
**役割:** 旅行代理店アシスタント

**目的:**  
あなたは Contoso Travel のための AI 搭載旅行代理店アシスタントです。主な目的は、顧客がフライトを見つけ、予約し、管理するのを支援し、顧客の希望とニーズが効率的に満たされるようにすることです。

**主な責務:**

1. **フライト検索:**
    
    - 顧客が指定した目的地、日付、その他の希望に基づき、利用可能なフライトを検索します。
    - フライト時刻、航空会社、乗継、価格などの選択肢一覧を提示します。
2. **フライト予約:**
    
    - 顧客のフライト予約を手配し、すべての詳細がシステムに正確に入力されるようにします。
    - 予約を確定し、確認番号などの必要情報を含む旅程を顧客に提供します。
3. **顧客の希望の確認:**
    
    - 座席（例: 通路側、窓側、足元広め）や希望するフライト時間帯（例: 朝、午後、夕方）について積極的に確認します。
    - これらの希望を記録し、将来の提案に反映します。
4. **フライトのキャンセル:**
    
    - 必要に応じて、会社のポリシーと手順に従って予約済みフライトのキャンセルを支援します。
    - 返金やキャンセルに必要な追加手続きがある場合は顧客に通知します。
5. **フライト監視:**
    
    - 予約済みフライトの状況を監視し、遅延・欠航・スケジュール変更をリアルタイムで顧客に通知します。
    - 必要に応じて希望する連絡手段（例: メール、SMS）で更新情報を提供します。

**語調とスタイル:**

- すべての顧客対応において、親しみやすく、プロフェッショナルで、話しかけやすい態度を保ちます。
- 顧客の具体的なニーズと質問に合わせて、明確で有益な情報提供を心掛けます。

**ユーザー対応の指針:**

- 顧客からの問い合わせに迅速かつ正確に回答します。
- 会話調でありつつ、プロ意識を保ちます。
- 注意深く、共感的かつ主体的に支援し、顧客満足を最優先します。

**補足:**

- 航空会社のポリシー変更、渡航制限、その他フライト予約や顧客経験に影響する情報を常に最新に保ちます。
- 専門用語は可能な限り避け、オプションや手続きを明確かつ簡潔に説明します。

この AI アシスタントは、Contoso Travel の顧客に対してフライト予約プロセスを効率的かつ効果的に進め、旅行に関するニーズを過不足なく満たすことを目的としています。
```

#### ステップ4: 繰り返し改善する

このシステムメッセージフレームワークの価値は、複数のエージェントのシステムメッセージ作成をスケールしやすくし、時間とともにシステムメッセージを改善できることにあります。最初から完全なユースケースに合うシステムメッセージができることは稀です。基本システムメッセージを少しずつ変更し、システムを通して実行することで、結果を比較・評価しながら改善を重ねることが可能です。

## 脅威の理解

信頼できるAIエージェントを構築するには、AIエージェントに対するリスクや脅威を理解し、軽減することが重要です。ここではAIエージェントに対するさまざまな脅威の一部を紹介し、それらに対してどのように計画し準備できるかを見ていきます。

![Understanding Threats](../../../06-building-trustworthy-agents/images/understanding-threats.png)

### タスクと指示の改変

**説明:** 攻撃者がプロンプトや入力の操作を通じて、AIエージェントの指示や目標を変更しようと試みる攻撃。

**軽減策:** 危険なプロンプトを検出するために、バリデーションチェックや入力フィルターを実行します。こうした攻撃は通常、エージェントとの頻繁なやり取りを必要とするため、会話のターン数を制限することも防止策になります。

### 重要システムへのアクセス

**説明:** AIエージェントが機密データを保管するシステムやサービスにアクセスできる場合、攻撃者がエージェントとこれらのサービス間の通信を侵害する可能性があります。これは直接的な攻撃であったり、エージェント経由でシステム情報を得ようとする間接的な試みであったりします。

**軽減策:** AIエージェントは必要最小限のアクセス権に限定すべきです。また、エージェントとシステム間の通信は安全でなければなりません。認証とアクセス制御の実装も情報保護の一手段です。

### リソースやサービスの過負荷

**説明:** AIエージェントはタスク完遂のために様々なツールやサービスにアクセスします。攻撃者はこれを利用し、AIエージェント経由で大量のリクエストを送信してサービスを攻撃し、システム障害や高額なコストを引き起こす可能性があります。

**軽減策:** AIエージェントがサービスに送るリクエスト数を制限するポリシーを実装します。また、会話のターン数やリクエスト数を制限することも有効です。

### ナレッジベースの汚染

**説明:** この攻撃はAIエージェント自体ではなく、AIエージェントが利用するナレッジベースや関連サービスを標的にします。データや情報を破損させることで、AIエージェントが偏ったり意図しない応答を返す原因となります。

**軽減策:** AIエージェントがワークフローで使用するデータを定期的に検証します。データへのアクセスは信頼できる人物のみに限定し、安全に管理することが重要です。

### 連鎖的なエラー

**説明:** AIエージェントは様々なツールやサービスにアクセスしてタスクを完遂します。攻撃者によるエラーが他のシステムの障害を引き起こし、問題が広範囲に及びトラブルシューティングが困難になることがあります。

**軽減策:** AIエージェントをDockerコンテナのような限定的な環境で動作させ、直接的なシステム攻撃を防ぐ方法があります。また、特定のシステムがエラーを返した際にフォールバック機能やリトライロジックを設けることも、システム全体の障害を防ぐ手段です。

## Human-in-the-Loop（人間介入型）

信頼できるAIエージェントシステムを構築するもう一つの効果的な方法は、Human-in-the-loopを活用することです。これにより、ユーザーが実行中のエージェントに対してフィードバックを提供できるフローが生まれます。ユーザーはマルチエージェントシステムの一員として、実行プロセスの承認や停止を行います。

![Human in The Loop](../../../06-building-trustworthy-agents/images/human-in-the-loop.png)

以下はAutoGenを使ってこの概念を実装したコードスニペットです：

```python
# エージェントを作成
model_client = OpenAIChatCompletionClient(model="gpt-4o-mini")
assistant = AssistantAgent("assistant", model_client=model_client)
user_proxy = UserProxyAgent("user_proxy", input_func=input)  # コンソールからの入力に input() を使用

# ユーザーが "APPROVE" と言ったら会話を終了する条件を作成
termination = TextMentionTermination("APPROVE")

# チームを作成
team = RoundRobinGroupChat([assistant, user_proxy], termination_condition=termination)

# 会話を実行してコンソールにストリーム出力
stream = team.run_stream(task="海について4行の詩を書いてください。")
# スクリプトで実行する場合は asyncio.run(...) を使用
await Console(stream)
```

## まとめ

信頼できるAIエージェントを構築するには、綿密な設計、堅牢なセキュリティ対策、継続的な改善が必要です。構造化されたメタプロンプトシステムの導入、潜在的な脅威の理解と対策の実施により、安全で効果的なAIエージェントを作ることができます。さらに、人間介入型のアプローチを取り入れることで、AIエージェントがユーザーのニーズに沿いながらリスクを最小化できるようになります。AIが進化し続ける中で、セキュリティ、プライバシー、倫理面に対して積極的に取り組む姿勢が、AIシステムの信頼性と安全性を高める鍵となります。

## 追加リソース

- <a href="https://learn.microsoft.com/azure/ai-studio/responsible-use-of-ai-overview" target="_blank">Responsible AI overview</a>
- <a href="https://learn.microsoft.com/azure/ai-studio/concepts/evaluation-approach-gen-ai" target="_blank">Evaluation of generative AI models and AI applications</a>
- <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/system-message?context=%2Fazure%2Fai-studio%2Fcontext%2Fcontext&tabs=top-techniques" target="_blank">Safety system messages</a>
- <a href="https://blogs.microsoft.com/wp-content/uploads/prod/sites/5/2022/06/Microsoft-RAI-Impact-Assessment-Template.pdf?culture=en-us&country=us" target="_blank">Risk Assessment Template</a>

## 前のレッスン

[Agentic RAG](../05-agentic-rag/README.md)

## 次のレッスン

[Planning Design Pattern](../07-planning-design/README.md)

**免責事項**:  
本書類はAI翻訳サービス[Co-op Translator](https://github.com/Azure/co-op-translator)を使用して翻訳されました。正確性を期しておりますが、自動翻訳には誤りや不正確な部分が含まれる可能性があります。原文の言語によるオリジナルの文書が正式な情報源とみなされるべきです。重要な情報については、専門の人間による翻訳を推奨します。本翻訳の利用により生じた誤解や誤訳について、当方は一切の責任を負いかねます。